name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AZURE_CONTAINER_APP_NAME: my-container-app
  AZURE_RESOURCE_GROUP: my-resource-group
  AZURE_CONTAINER_APP_ENVIRONMENT: my-environment

jobs:
  # Code Quality and Security Checks
  code-quality:
    name: Code Quality & Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup .NET (or your runtime)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify project file exists
        run: |
          ls -la
          if [ ! -f "tradingbrain.csproj" ]; then
            echo "Error: tradingbrain.csproj not found in root directory"
            exit 1
          fi

      # Static code analysis
      - name: Run code linting
        run: |
          dotnet format tradingbrain.csproj --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      # Dependency vulnerability scanning
      - name: Run dependency scan
        run: |
          dotnet list tradingbrain.csproj package --vulnerable --include-transitive
        continue-on-error: true

      # GitHub Code Scanning (CodeQL)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp  # Adjust for your language
          queries: security-extended,security-and-quality

      - name: Build for CodeQL analysis
        run: |
          dotnet build tradingbrain.csproj --configuration Release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"

      # Container image scanning
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify project file exists
        run: |
          ls -la
          if [ ! -f "tradingbrain.csproj" ]; then
            echo "Error: tradingbrain.csproj not found in root directory"
            exit 1
          fi

      - name: Restore dependencies
        run: dotnet restore tradingbrain.csproj

      - name: Build application
        run: dotnet build tradingbrain.csproj --configuration Release --no-restore

      - name: Run unit tests
        run: dotnet test tradingbrain.csproj --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'

      - name: Code coverage report
        uses: codecov/codecov-action@v4
        with:
          files: '**/coverage.cobertura.xml'
          fail_ci_if_error: false

  # Build and push container image (only on main branch or after PR approval)
  build-container:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
      id-token: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push container image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Scan container image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'container-scan-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload container scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'container-scan-results.sarif'

  # Manual approval gate for production deployment
  approval:
    name: Await Manual Approval
    runs-on: ubuntu-latest
    needs: build-container
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Wait for approval
        run: echo "Deployment approved for production environment"

  # Deploy to Azure Container Apps
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [build-container, approval]
    environment:
      name: production
      url: https://${{ env.AZURE_CONTAINER_APP_NAME }}.azurecontainerapps.io
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          imageToDeploy: ${{ needs.build-container.outputs.image-tag }}
          targetPort: 8080

      - name: Verify deployment
        run: |
          az containerapp show \
            --name ${{ env.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.latestRevisionName" \
            --output tsv

      - name: Run smoke tests
        run: |
          APP_URL="https://${{ env.AZURE_CONTAINER_APP_NAME }}.azurecontainerapps.io"
          echo "Testing deployment at $APP_URL"
          curl -f -s -o /dev/null -w "%{http_code}" $APP_URL/health || exit 1

  # Notify on deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
            exit 1
          fi
