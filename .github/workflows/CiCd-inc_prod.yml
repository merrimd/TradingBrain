name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write
  packages: write
  pull-requests: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/tradingbrain
  AZURE_CONTAINER_APP_NAME_TEST: tradingbrain-grid-test
  AZURE_CONTAINER_APP_NAME_PROD: tradingbrain-grid-prod
  AZURE_RESOURCE_GROUP: IGContainerGrp
  AZURE_CONTAINER_APP_ENVIRONMENT: managedEnvironment-IGContainerGrp-93fe

jobs:
  # Code Quality and Security Checks
  code-quality:
    name: Code Quality & Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write
      pull-requests: write
      statuses: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify project file exists
        run: |
          ls -la
          if [ ! -f "TradingBrain.csproj" ]; then
            echo "Error: TradingBrain.csproj not found in root directory"
            exit 1
          fi

      - name: Run code linting
        run: |
          dotnet format TradingBrain.csproj --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Run dependency scan
        run: |
          dotnet list TradingBrain.csproj package --vulnerable --include-transitive
        continue-on-error: true

      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~\sonar\cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache SonarCloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@v3
        with:
          path: .\.sonar\scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner

      - name: Install SonarCloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        run: |
          dotnet tool install --global dotnet-sonarscanner

      - name: Build and analyze with SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin /k:"${{ secrets.SONAR_PROJECT_KEY }}" /o:"${{ secrets.SONAR_ORGANIZATION }}" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io"
          dotnet build TradingBrain.csproj --configuration Release
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Wait for SonarCloud Quality Gate
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}

      # Commented out to allow testing even when quality gate fails
       - name: Check SonarCloud Quality Gate Status
         run: |
           echo "Checking Quality Gate status..."
           QUALITY_GATE_STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
             "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ secrets.SONAR_PROJECT_KEY }}" \
             | jq -r '.projectStatus.status')
           
           echo "Quality Gate Status: $QUALITY_GATE_STATUS"
           
           if [ "$QUALITY_GATE_STATUS" != "OK" ]; then
             echo "‚ùå Quality Gate failed! Check SonarCloud dashboard for details."
             echo "https://sonarcloud.io/dashboard?id=${{ secrets.SONAR_PROJECT_KEY }}"
             exit 1
           fi
           
           echo "‚úÖ Quality Gate passed!"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      # Commented out - GitHub Security tab upload disabled
      # - name: Upload Trivy results to GitHub Security
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always()
      #   with:
      #     sarif_file: 'trivy-results.sarif'

  # Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: code-quality
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify project file exists
        run: |
          ls -la
          if [ ! -f "TradingBrain.csproj" ]; then
            echo "Error: TradingBrain.csproj not found in root directory"
            exit 1
          fi

      - name: Restore dependencies
        run: dotnet restore TradingBrain.csproj

      - name: Build application
        run: dotnet build TradingBrain.csproj --configuration Release --no-restore

      - name: Run unit tests
        run: dotnet test TradingBrain.csproj --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'

  # Build and push container image
  build-container:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
      id-token: write
    
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=v1-
            type=raw,value=v1-latest

      - name: Build and push container image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Get image tag
        id: image-tag
        run: |
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | grep "v1-" | grep -v "latest" | head -n 1 | cut -d':' -f2)
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $IMAGE_TAG"

      - name: Output image details
        run: |
          echo "Image tags: ${{ steps.meta.outputs.tags }}"
          echo "Image digest: ${{ steps.build.outputs.digest }}"
          echo "Unique tag: ${{ steps.image-tag.outputs.tag }}"
          echo "Full image reference: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}"

      - name: Scan container image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
          format: 'sarif'
          output: 'container-scan-results.sarif'
          severity: 'CRITICAL,HIGH'

      # Commented out - GitHub Security tab upload disabled
      # - name: Upload container scan results
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always()
      #   with:
      #     sarif_file: 'container-scan-results.sarif'

  # Manual approval gate for test deployment
  approval-test:
    name: Await Test Deployment Approval
    runs-on: ubuntu-latest
    needs: build-container
    environment:
      name: test-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Wait for approval
        run: |
          echo "‚úÖ Test deployment approved"
          echo "üì¶ Image: ${{ needs.build-container.outputs.image-tag }}"

  # Deploy to Test Environment
  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [build-container, approval-test]
    environment:
      name: test
      url: https://${{ env.AZURE_CONTAINER_APP_NAME_TEST }}.azurecontainerapps.io
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Container Registry credentials
        run: |
          az containerapp registry set \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_TEST }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --server ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password ${{ secrets.GHCR_PAT }}

      - name: Deploy to Test Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_TEST }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-container.outputs.image-tag }}

      - name: Get latest revision
        id: revision
        run: |
          REVISION=$(az containerapp show \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_TEST }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.latestRevisionName" \
            --output tsv)
          echo "revision_name=$REVISION" >> $GITHUB_OUTPUT

      - name: Verify test deployment
        run: |
          echo "Deployed revision: ${{ steps.revision.outputs.revision_name }}"
          az containerapp revision show \
            --revision ${{ steps.revision.outputs.revision_name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Run smoke tests on test environment
        run: |
          APP_URL="https://${{ env.AZURE_CONTAINER_APP_NAME_TEST }}.azurecontainerapps.io"
          echo "Testing deployment at $APP_URL"
          curl -f -s -o /dev/null -w "%{http_code}" $APP_URL/health || echo "Health check endpoint not available yet"

  # Manual approval gate for production deployment
  approval-production:
    name: Await Production Deployment Approval
    runs-on: ubuntu-latest
    needs: deploy-test
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Wait for production approval
        run: |
          echo "‚úÖ Production deployment approved"
          echo "üì¶ Deploying tested image from test environment"

  # Deploy to Production Environment
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: [build-container, approval-production]
    environment:
      name: production
      url: https://${{ env.AZURE_CONTAINER_APP_NAME_PROD }}.azurecontainerapps.io
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Container Registry credentials
        run: |
          az containerapp registry set \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_PROD }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --server ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password ${{ secrets.GHCR_PAT }}

      - name: Deploy to Production Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_PROD }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-container.outputs.image-tag }}

      - name: Get latest revision
        id: revision
        run: |
          REVISION=$(az containerapp show \
            --name ${{ env.AZURE_CONTAINER_APP_NAME_PROD }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.latestRevisionName" \
            --output tsv)
          echo "revision_name=$REVISION" >> $GITHUB_OUTPUT

      - name: Verify production deployment
        run: |
          echo "Deployed revision: ${{ steps.revision.outputs.revision_name }}"
          az containerapp revision show \
            --revision ${{ steps.revision.outputs.revision_name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Run smoke tests on production
        run: |
          APP_URL="https://${{ env.AZURE_CONTAINER_APP_NAME_PROD }}.azurecontainerapps.io"
          echo "Testing deployment at $APP_URL"
          curl -f -s -o /dev/null -w "%{http_code}" $APP_URL/health || echo "Health check endpoint not available yet"

  # Notify on deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "‚úÖ Production deployment successful"
          else
            echo "‚ùå Production deployment failed"
            exit 1
          fi
